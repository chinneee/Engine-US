import streamlit as st
import pandas as pd
import gspread
from gspread_dataframe import set_with_dataframe
from google.oauth2.service_account import Credentials
import json
import io
import re
from datetime import datetime
import time

# Page configuration
st.set_page_config(
    page_title="Data Update Manager",
    page_icon="üìä",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS for better UI
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 2rem;
    }
    .tab-header {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 1rem;
    }
    .success-box {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        margin: 1rem 0;
    }
    .error-box {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        margin: 1rem 0;
    }
    .info-box {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #cce7ff;
        border: 1px solid #b8daff;
        color: #004085;
        margin: 1rem 0;
    }
</style>
""", unsafe_allow_html=True)

# Initialize session state
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False
if 'client' not in st.session_state:
    st.session_state.client = None

def authenticate_google_sheets():
    """Authenticate with Google Sheets API"""
    try:
        # Get credentials from Streamlit secrets
        creds_dict = dict(st.secrets["gcp_service_account"])
        
        scopes = [
            "https://www.googleapis.com/auth/spreadsheets", 
            "https://www.googleapis.com/auth/drive"
        ]
        
        creds = Credentials.from_service_account_info(creds_dict, scopes=scopes)
        client = gspread.authorize(creds)
        
        return client
    except Exception as e:
        st.error(f"‚ùå L·ªói x√°c th·ª±c Google Sheets: {str(e)}")
        return None

def get_google_sheet(client, sheet_id, worksheet_name):
    """Get specific worksheet from Google Sheets"""
    try:
        spreadsheet = client.open_by_key(sheet_id)
        worksheet = spreadsheet.worksheet(worksheet_name)
        return worksheet
    except Exception as e:
        st.error(f"‚ùå Kh√¥ng th·ªÉ m·ªü worksheet '{worksheet_name}': {str(e)}")
        return None

def update_sheet_data(worksheet, data):
    """Update Google Sheet with new data"""
    try:
        # Clear existing data
        worksheet.clear()
        
        # Update with new data
        set_with_dataframe(worksheet, data, include_index=False)
        
        return True
    except Exception as e:
        st.error(f"‚ùå L·ªói c·∫≠p nh·∫≠t d·ªØ li·ªáu: {str(e)}")
        return False

def extract_date_from_filename(filename):
    """Extract start and end date from SellerBoard filename"""
    try:
        # Pattern: NewEleven_Dashboard Products Group by ASIN_01_07_2025-31_07_2025_(08_44_44_695).xlsx
        pattern = r'(\d{2}_\d{2}_\d{4})-(\d{2}_\d{2}_\d{4})'
        match = re.search(pattern, filename)
        
        if match:
            start_date_str = match.group(1)  # 01_07_2025
            end_date_str = match.group(2)    # 31_07_2025
            
            # Extract month from start date (format: DD_MM_YYYY)
            month = int(start_date_str.split('_')[1])
            year = int(start_date_str.split('_')[2])
            
            # Calculate quarter
            quarter = (month - 1) // 3 + 1
            
            return month, quarter, year
        else:
            return None, None, None
    except Exception as e:
        st.error(f"‚ùå L·ªói extract ng√†y t·ª´ filename: {str(e)}")
        return None, None, None

def extract_date_from_brand_analytics_filename(filename):
    """Extract month and year from Brand Analytics filename"""
    try:
        # Pattern: US_Search_Catalog_Performance_Simple_Month_2025_07_31
        pattern = r'(\d{4})_(\d{2})_(\d{2})\.csv?$'
        match = re.search(pattern, filename)
        
        if match:
            year = int(match.group(1))    # 2025
            month = int(match.group(2))   # 07
            day = int(match.group(3))     # 31
            
            # Calculate quarter
            quarter = (month - 1) // 3 + 1
            
            return month, quarter, year
        else:
            return None, None, None
    except Exception as e:
        st.error(f"‚ùå L·ªói extract ng√†y t·ª´ Brand Analytics filename: {str(e)}")
        return None, None, None

def add_month_quarter_columns(df, month, quarter):
    """Add Month and Quarter columns to dataframe"""
    try:
        df_copy = df.copy()
        
        # Add Month and Quarter columns at the beginning
        df_copy.insert(0, 'Quarter', quarter)
        df_copy.insert(1, 'Month', month)
        
        return df_copy
    except Exception as e:
        st.error(f"‚ùå L·ªói th√™m c·ªôt Month/Quarter: {str(e)}")
        return None

def get_existing_data_count(worksheet):
    """Get number of existing rows in worksheet (excluding header)"""
    try:
        all_values = worksheet.get_all_values()
        # Subtract 1 for header row, return 0 if only header exists
        return max(0, len(all_values) - 1)
    except Exception as e:
        st.error(f"‚ùå L·ªói ƒë·∫øm d·ªØ li·ªáu hi·ªán c√≥: {str(e)}")
        return 0

def append_to_sheet(worksheet, new_data):
    """Append new data to existing sheet nhanh h∆°n"""
    try:
        # L·∫•y header hi·ªán t·∫°i
        existing_headers = worksheet.row_values(1)
        if not existing_headers:
            # N·∫øu sheet r·ªóng th√¨ ghi lu√¥n c·∫£ header + data
            set_with_dataframe(worksheet, new_data.fillna(""), include_index=False)
            return True

        # ƒê·∫£m b·∫£o th·ª© t·ª± c·ªôt theo sheet
        reordered_data = pd.DataFrame()
        for header in existing_headers:
            if header in new_data.columns:
                reordered_data[header] = new_data[header]
            else:
                reordered_data[header] = ""

        # Th√™m c√°c c·ªôt m·ªõi (n·∫øu c√≥)
        for col in new_data.columns:
            if col not in existing_headers:
                reordered_data[col] = new_data[col]

        # X·ª≠ l√Ω NaN
        reordered_data = reordered_data.fillna("")

        # L·∫•y s·ªë d√≤ng hi·ªán c√≥ (tr·ª´ header)
        existing_rows = len(worksheet.get_all_values()) - 1

        # Ghi d·ªØ li·ªáu m·ªõi b·∫Øt ƒë·∫ßu t·ª´ d√≤ng ti·∫øp theo
        set_with_dataframe(
            worksheet,
            reordered_data,
            include_index=False,
            include_column_header=False,  # ‚úÖ B·ªè header
            row=existing_rows + 1         # ch·ªâ +1 v√¨ kh√¥ng c√≤n header
        )

        return True
    except Exception as e:
        st.error(f"‚ùå L·ªói append d·ªØ li·ªáu: {str(e)}")
        return False

def validate_file_format(uploaded_file, expected_format):
    """Validate uploaded file format"""
    if expected_format == "txt":
        return uploaded_file.name.endswith('.txt')
    elif expected_format == "csv":
        return uploaded_file.name.endswith('.csv')
    elif expected_format == "xlsx":
        return uploaded_file.name.endswith('.xlsx') or uploaded_file.name.endswith('.xls')
    return False

def process_inventory_file(uploaded_file):
    """Process inventory .txt file"""
    try:
        # Read text file
        content = uploaded_file.read().decode('utf-8')
        lines = content.strip().split('\n')
        
        # Convert to DataFrame (assuming tab-separated or comma-separated)
        data = []
        for line in lines:
            # Try different separators
            if '\t' in line:
                data.append(line.split('\t'))
            elif ',' in line:
                data.append(line.split(','))
            else:
                data.append([line])
        
        df = pd.DataFrame(data)
        
        # If first row looks like headers, use it
        if len(df) > 1:
            df.columns = df.iloc[0]
            df = df[1:].reset_index(drop=True)
        
        return df
    except Exception as e:
        st.error(f"‚ùå L·ªói x·ª≠ l√Ω file Inventory: {str(e)}")
        return None

def process_excel_file(uploaded_file):
    """Process Excel file (.xlsx)"""
    try:
        df = pd.read_excel(uploaded_file)
        return df
    except Exception as e:
        st.error(f"‚ùå L·ªói ƒë·ªçc file Excel: {str(e)}")
        return None
    
def process_csv_file(uploaded_file):
    """Process Excel file (.xlsx)"""
    try:
        df = pd.read_csv(uploaded_file, skiprows=1)
        return df
    except Exception as e:
        st.error(f"‚ùå L·ªói ƒë·ªçc file Excel: {str(e)}")
        return None

def get_existing_columns(worksheet):
    """Get existing column headers from worksheet"""
    try:
        headers = worksheet.row_values(1)
        return [header for header in headers if header.strip()]  # Remove empty headers
    except Exception as e:
        st.error(f"‚ùå L·ªói l·∫•y headers t·ª´ sheet: {str(e)}")
        return []

def filter_and_reorder_data(df, existing_columns):
    """Filter dataframe to only include columns that exist in the target sheet and reorder them"""
    try:
        # Find matching columns (case-insensitive comparison)
        df_columns_lower = {col.lower(): col for col in df.columns}
        existing_columns_lower = {col.lower(): col for col in existing_columns}
        
        matching_columns = []
        for existing_col_lower, existing_col in existing_columns_lower.items():
            if existing_col_lower in df_columns_lower:
                matching_columns.append((existing_col, df_columns_lower[existing_col_lower]))
        
        if not matching_columns:
            st.error("‚ùå Kh√¥ng t√¨m th·∫•y c·ªôt n√†o tr√πng kh·ªõp v·ªõi sheet g·ªëc!")
            return None, [], []
        
        # Create filtered dataframe with correct column order
        filtered_df = pd.DataFrame()
        matched_sheet_columns = []
        matched_file_columns = []
        
        for sheet_col, file_col in matching_columns:
            filtered_df[sheet_col] = df[file_col]
            matched_sheet_columns.append(sheet_col)
            matched_file_columns.append(file_col)
        
        return filtered_df, matched_sheet_columns, matched_file_columns
        
    except Exception as e:
        st.error(f"‚ùå L·ªói filter v√† reorder data: {str(e)}")
        return None, [], []


# Main app
def main():
    st.markdown('<h1 class="main-header">üìä Data Update Manager</h1>', unsafe_allow_html=True)
    
    # Sidebar for configuration
    with st.sidebar:
        st.header("‚öôÔ∏è C·∫•u h√¨nh")
        
        # Google Sheet ID input
        sheet_id = st.text_input(
            "Google Sheet ID", 
            value="11HBMec3fPMt-8_dxaC0VcyKT0yPQVfsURnZgAKkxwKg",
            help="ID c·ªßa Google Sheet c·∫ßn update"
        )
        
        # Authentication button
        if st.button("üîê K·∫øt n·ªëi Google Sheets"):
            with st.spinner("ƒêang k·∫øt n·ªëi..."):
                client = authenticate_google_sheets()
                if client:
                    st.session_state.client = client
                    st.session_state.authenticated = True
                    st.success("‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!")
                else:
                    st.session_state.authenticated = False
        
        # Connection status
        if st.session_state.authenticated:
            st.success("üü¢ ƒê√£ k·∫øt n·ªëi Google Sheets")
        else:
            st.warning("üü° Ch∆∞a k·∫øt n·ªëi Google Sheets")
    
    # Main content tabs - Added tab5 for Brand Analytics
    tab1, tab2, tab3, tab4, tab5 = st.tabs(["üì¶ Update Inventory", "üè∑Ô∏è Update T. ASIN", "üöÄ Update T. Launching", "üìà Data SellerBoard", "üîç Data Brand Analytics"])
    
    # Tab 1: Update Inventory
    with tab1:
        st.markdown('<h2 class="tab-header">üì¶ Update Inventory</h2>', unsafe_allow_html=True)
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.markdown('<div class="info-box">üìÅ Upload file Inventory (.txt)</div>', unsafe_allow_html=True)
            
            inventory_file = st.file_uploader(
                "Ch·ªçn file Inventory",
                type=['txt'],
                key="inventory_uploader"
            )
            
            if inventory_file is not None:
                if validate_file_format(inventory_file, "txt"):
                    # Process file
                    df = process_inventory_file(inventory_file)
                    
                    if df is not None:
                        st.success(f"‚úÖ ƒê√£ ƒë·ªçc file th√†nh c√¥ng! ({len(df)} d√≤ng d·ªØ li·ªáu)")
                        
                        # Preview data
                        st.subheader("üëÄ Preview d·ªØ li·ªáu:")
                        st.dataframe(df.head(10), use_container_width=True)
                        
                        # Update button
                        if st.session_state.authenticated:
                            if st.button("üîÑ Update Inventory", key="update_inventory"):
                                with st.spinner("ƒêang c·∫≠p nh·∫≠t..."):
                                    worksheet = get_google_sheet(st.session_state.client, sheet_id, "Inventory")
                                    if worksheet:
                                        if update_sheet_data(worksheet, df):
                                            st.markdown('<div class="success-box">‚úÖ C·∫≠p nh·∫≠t Inventory th√†nh c√¥ng!</div>', unsafe_allow_html=True)
                                            st.balloons()
                                        else:
                                            st.markdown('<div class="error-box">‚ùå C·∫≠p nh·∫≠t th·∫•t b·∫°i!</div>', unsafe_allow_html=True)
                        else:
                            st.warning("‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi Google Sheets tr∆∞·ªõc!")
                else:
                    st.error("‚ùå File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng .txt")
        
        with col2:
            st.info("""
            **üìã H∆∞·ªõng d·∫´n:**
            1. Ch·ªçn file .txt ch·ª©a d·ªØ li·ªáu Inventory
            2. Ki·ªÉm tra preview d·ªØ li·ªáu
            3. Nh·∫•n "Update Inventory" ƒë·ªÉ c·∫≠p nh·∫≠t
            
            **üìù L∆∞u √Ω:**
            - File ph·∫£i c√≥ ƒë·ªãnh d·∫°ng .txt
            - D·ªØ li·ªáu ph√¢n c√°ch b·∫±ng tab ho·∫∑c comma
            """)
    
    # Tab 2: Update T. ASIN
    with tab2:
        st.markdown('<h2 class="tab-header">üè∑Ô∏è Update T. ASIN</h2>', unsafe_allow_html=True)
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.markdown('<div class="info-box">üìä Upload file T. ASIN (.xlsx)</div>', unsafe_allow_html=True)
            
            asin_file = st.file_uploader(
                "Ch·ªçn file T. ASIN",
                type=['xlsx', 'xls'],
                key="asin_uploader"
            )
            
            if asin_file is not None:
                if validate_file_format(asin_file, "xlsx"):
                    # Process file
                    df = process_excel_file(asin_file)
                    
                    if df is not None:
                        st.success(f"‚úÖ ƒê√£ ƒë·ªçc file th√†nh c√¥ng! ({len(df)} d√≤ng d·ªØ li·ªáu)")
                        
                        # Preview data
                        st.subheader("üëÄ Preview d·ªØ li·ªáu:")
                        st.dataframe(df.head(10), use_container_width=True)
                        
                        # Update button
                        if st.session_state.authenticated:
                            if st.button("üîÑ Update T. ASIN", key="update_asin"):
                                with st.spinner("ƒêang c·∫≠p nh·∫≠t..."):
                                    worksheet = get_google_sheet(st.session_state.client, sheet_id, "T. ASIN")
                                    if worksheet:
                                        if update_sheet_data(worksheet, df):
                                            st.markdown('<div class="success-box">‚úÖ C·∫≠p nh·∫≠t T. ASIN th√†nh c√¥ng!</div>', unsafe_allow_html=True)
                                            st.balloons()
                                        else:
                                            st.markdown('<div class="error-box">‚ùå C·∫≠p nh·∫≠t th·∫•t b·∫°i!</div>', unsafe_allow_html=True)
                        else:
                            st.warning("‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi Google Sheets tr∆∞·ªõc!")
                else:
                    st.error("‚ùå File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng .xlsx/.xls")
        
        with col2:
            st.info("""
            **üìã H∆∞·ªõng d·∫´n:**
            1. Ch·ªçn file .xlsx ch·ª©a d·ªØ li·ªáu T. ASIN
            2. Ki·ªÉm tra preview d·ªØ li·ªáu
            3. Nh·∫•n "Update T. ASIN" ƒë·ªÉ c·∫≠p nh·∫≠t
            
            **üìù L∆∞u √Ω:**
            - File ph·∫£i c√≥ ƒë·ªãnh d·∫°ng .xlsx ho·∫∑c .xls
            - D·ªØ li·ªáu s·∫Ω ghi ƒë√® worksheet "T. ASIN"
            """)
    
    # Tab 3: Update T. Launching
    with tab3:
        st.markdown('<h2 class="tab-header">üöÄ Update T. Launching</h2>', unsafe_allow_html=True)
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.markdown('<div class="info-box">üéØ Upload file T. Launching (.xlsx)</div>', unsafe_allow_html=True)
            
            launching_file = st.file_uploader(
                "Ch·ªçn file T. Launching",
                type=['xlsx', 'xls'],
                key="launching_uploader"
            )
            
            if launching_file is not None:
                if validate_file_format(launching_file, "xlsx"):
                    # Process file
                    df = process_excel_file(launching_file)
                    
                    if df is not None:
                        st.success(f"‚úÖ ƒê√£ ƒë·ªçc file th√†nh c√¥ng! ({len(df)} d√≤ng d·ªØ li·ªáu)")
                        
                        # Preview data
                        st.subheader("üëÄ Preview d·ªØ li·ªáu:")
                        st.dataframe(df.head(10), use_container_width=True)
                        
                        # Update button
                        if st.session_state.authenticated:
                            if st.button("üîÑ Update T. Launching", key="update_launching"):
                                with st.spinner("ƒêang c·∫≠p nh·∫≠t..."):
                                    worksheet = get_google_sheet(st.session_state.client, sheet_id, "T. Launching")
                                    if worksheet:
                                        if update_sheet_data(worksheet, df):
                                            st.markdown('<div class="success-box">‚úÖ C·∫≠p nh·∫≠t T. Launching th√†nh c√¥ng!</div>', unsafe_allow_html=True)
                                            st.balloons()
                                        else:
                                            st.markdown('<div class="error-box">‚ùå C·∫≠p nh·∫≠t th·∫•t b·∫°i!</div>', unsafe_allow_html=True)
                        else:
                            st.warning("‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi Google Sheets tr∆∞·ªõc!")
                else:
                    st.error("‚ùå File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng .xlsx/.xls")
        
        with col2:
            st.info("""
            **üìã H∆∞·ªõng d·∫´n:**
            1. Ch·ªçn file .xlsx ch·ª©a d·ªØ li·ªáu T. Launching
            2. Ki·ªÉm tra preview d·ªØ li·ªáu
            3. Nh·∫•n "Update T. Launching" ƒë·ªÉ c·∫≠p nh·∫≠t
            
            **üìù L∆∞u √Ω:**
            - File ph·∫£i c√≥ ƒë·ªãnh d·∫°ng .xlsx ho·∫∑c .xls
            - D·ªØ li·ªáu s·∫Ω ghi ƒë√® worksheet "T. Launching"
            """)
    
    # Tab 4: Data SellerBoard
    with tab4:
        st.markdown('<h2 class="tab-header">üìà Data SellerBoard</h2>', unsafe_allow_html=True)
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.markdown('<div class="info-box">üìä Upload file SellerBoard (.xlsx)</div>', unsafe_allow_html=True)
            
            sellerboard_file = st.file_uploader(
                "Ch·ªçn file SellerBoard",
                type=['xlsx', 'xls'],
                key="sellerboard_uploader",
                help="File format: NewEleven_Dashboard Products Group by ASIN_DD_MM_YYYY-DD_MM_YYYY_(timestamp).xlsx"
            )
            
            if sellerboard_file is not None:
                if validate_file_format(sellerboard_file, "xlsx"):
                    # Extract date info from filename
                    month, quarter, year = extract_date_from_filename(sellerboard_file.name)
                    
                    if month and quarter and year:
                        st.success(f"‚úÖ Detected: Th√°ng {month}/{year} - Quarter {quarter}")
                        
                        # Process file
                        df = process_excel_file(sellerboard_file)
                        
                        if df is not None:
                            st.success(f"‚úÖ ƒê√£ ƒë·ªçc file th√†nh c√¥ng! ({len(df)} d√≤ng d·ªØ li·ªáu)")
                            
                            # Add Month and Quarter columns
                            df_with_metadata = add_month_quarter_columns(df, month, quarter)
                            
                            if df_with_metadata is not None:
                                # Preview data with new columns
                                st.subheader("üëÄ Preview d·ªØ li·ªáu (v·ªõi c·ªôt Month & Quarter):")
                                st.dataframe(df_with_metadata.head(10), use_container_width=True)
                                
                                # Show column info
                                st.info(f"üìã T·ªïng c·ªông: {len(df_with_metadata.columns)} c·ªôt, {len(df_with_metadata)} d√≤ng")
                                
                                # Update button
                                if st.session_state.authenticated:
                                    # Check existing data count
                                    worksheet = get_google_sheet(st.session_state.client, sheet_id, "SB_US_2025")
                                    if worksheet:
                                        existing_count = get_existing_data_count(worksheet)
                                        st.info(f"üìä D·ªØ li·ªáu hi·ªán t·∫°i trong sheet SB_US_2025: {existing_count} d√≤ng")
                                    
                                    if st.button("üìà Append to SB_US_2025", key="append_sellerboard"):
                                        with st.spinner("ƒêang append d·ªØ li·ªáu..."):
                                            if worksheet:
                                                if append_to_sheet(worksheet, df_with_metadata):
                                                    new_count = get_existing_data_count(worksheet)
                                                    added_rows = new_count - existing_count
                                                    st.markdown(f'<div class="success-box">‚úÖ Append SellerBoard th√†nh c√¥ng!<br>üìä ƒê√£ th√™m {added_rows} d√≤ng d·ªØ li·ªáu<br>üìà T·ªïng d·ªØ li·ªáu hi·ªán t·∫°i: {new_count} d√≤ng</div>', unsafe_allow_html=True)
                                                    st.balloons()
                                                else:
                                                    st.markdown('<div class="error-box">‚ùå Append th·∫•t b·∫°i!</div>', unsafe_allow_html=True)
                                else:
                                    st.warning("‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi Google Sheets tr∆∞·ªõc!")
                    else:
                        st.error("‚ùå Kh√¥ng th·ªÉ detect th√°ng/nƒÉm t·ª´ t√™n file. Vui l√≤ng ki·ªÉm tra format t√™n file!")
                        st.info("üìù Format ƒë√∫ng: NewEleven_Dashboard Products Group by ASIN_DD_MM_YYYY-DD_MM_YYYY_(timestamp).xlsx")
                else:
                    st.error("‚ùå File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng .xlsx/.xls")
        
        with col2:
            st.info("""
            **üìã H∆∞·ªõng d·∫´n:**
            1. Ch·ªçn file .xlsx SellerBoard
            2. H·ªá th·ªëng t·ª± ƒë·ªông detect th√°ng/quarter
            3. Th√™m c·ªôt Month & Quarter
            4. Append v√†o sheet SB_US_2025
            
            **üìù Format t√™n file:**
            ```
            NewEleven_Dashboard Products Group by ASIN_
            01_07_2025-31_07_2025_
            (08_44_44_695).xlsx
            ```
            
            **üî¢ Quarter mapping:**
            - Q1: Th√°ng 1,2,3
            - Q2: Th√°ng 4,5,6  
            - Q3: Th√°ng 7,8,9
            - Q4: Th√°ng 10,11,12
            
            **‚ö†Ô∏è L∆∞u √Ω:**
            - D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c append v√†o cu·ªëi sheet
            - Th·ª© t·ª± c·ªôt s·∫Ω ƒë∆∞·ª£c maintain theo sheet g·ªëc
            - C·ªôt Month v√† Quarter s·∫Ω ƒë∆∞·ª£c th√™m v√†o cu·ªëi
            """)

    # Tab 5: Data Brand Analytics

    with tab5:
        st.markdown('<h2 class="tab-header">üîç Data Brand Analytics</h2>', unsafe_allow_html=True)
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.markdown('<div class="info-box">üìä Upload file Brand Analytics (.csv)</div>', unsafe_allow_html=True)
            
            brand_analytics_file = st.file_uploader(
                "Ch·ªçn file Brand Analytics",
                type=['csv'],
                key="brand_analytics_uploader",
                help="File format: US_Search_Catalog_Performance_Simple_Month_YYYY_MM_DD.csv"
            )
            
            if brand_analytics_file is not None:
                if validate_file_format(brand_analytics_file, "csv"):
                    # 1. Extract date info from filename
                    month, quarter, year = extract_date_from_brand_analytics_filename(brand_analytics_file.name)
                    
                    if month and quarter and year:
                        st.success(f"‚úÖ Detected: Th√°ng {month}/{year} - Quarter {quarter}")
                        
                        # 2. Process CSV file
                        df = process_csv_file(brand_analytics_file)
                        
                        if df is not None:
                            st.success(f"‚úÖ ƒê√£ ƒë·ªçc file th√†nh c√¥ng! ({len(df)} d√≤ng d·ªØ li·ªáu)")
                            st.info(f"üìä Columns trong file: {len(df.columns)} c·ªôt")
                            
                            # Check authentication before getting sheet data
                            if st.session_state.authenticated:
                                # 3. Get existing columns from BA_US_2025 sheet
                                worksheet = get_google_sheet(st.session_state.client, sheet_id, "BA_US_2025")
                                if worksheet:
                                    existing_columns = get_existing_columns(worksheet)
                                    existing_count = get_existing_data_count(worksheet)
                                    
                                    if existing_columns:
                                        st.info(f"üìã Columns trong sheet BA_US_2025: {len(existing_columns)} c·ªôt")
                                        st.info(f"üìä D·ªØ li·ªáu hi·ªán t·∫°i trong sheet: {existing_count} d√≤ng")
                                        
                                        # 4. Column Matching - Filter and reorder data
                                        filtered_df, matched_sheet_cols, matched_file_cols = filter_and_reorder_data(df, existing_columns)
                                        
                                        if filtered_df is not None:
                                            st.success(f"‚úÖ Matched {len(matched_sheet_cols)} c·ªôt v·ªõi sheet g·ªëc")
                                            
                                            # Show matched columns in expandable table
                                            with st.expander("üìã Chi ti·∫øt c·ªôt matched"):
                                                match_info = pd.DataFrame({
                                                    'Sheet Column': matched_sheet_cols,
                                                    'File Column': matched_file_cols
                                                })
                                                st.dataframe(match_info, use_container_width=True)
                                            
                                            # 5. Add Month and Quarter columns
                                            df_with_metadata = add_month_quarter_columns(filtered_df, month, quarter)
                                            
                                            if df_with_metadata is not None:
                                                # Data Preview with filtered data
                                                st.subheader("üëÄ Preview d·ªØ li·ªáu ƒë√£ filter (v·ªõi c·ªôt Month & Quarter):")
                                                st.dataframe(df_with_metadata.head(10), use_container_width=True)
                                                
                                                # Show final column info
                                                st.info(f"üìã D·ªØ li·ªáu cu·ªëi c√πng: {len(df_with_metadata.columns)} c·ªôt, {len(df_with_metadata)} d√≤ng")
                                                
                                                # 6. Append button - only compatible columns
                                                if st.button("üîç Append to BA_US_2025", key="append_brand_analytics"):
                                                    with st.spinner("ƒêang append d·ªØ li·ªáu..."):
                                                        if append_to_sheet(worksheet, df_with_metadata):
                                                            new_count = get_existing_data_count(worksheet)
                                                            added_rows = new_count - existing_count
                                                            st.markdown(f'<div class="success-box">‚úÖ Append Brand Analytics th√†nh c√¥ng!<br>üìä ƒê√£ th√™m {added_rows} d√≤ng d·ªØ li·ªáu<br>üìà T·ªïng d·ªØ li·ªáu hi·ªán t·∫°i: {new_count} d√≤ng</div>', unsafe_allow_html=True)
                                                            st.balloons()
                                                        else:
                                                            st.markdown('<div class="error-box">‚ùå Append th·∫•t b·∫°i!</div>', unsafe_allow_html=True)
                                        else:
                                            st.error("‚ùå Kh√¥ng c√≥ c·ªôt n√†o tr√πng kh·ªõp v·ªõi sheet BA_US_2025!")
                                    else:
                                        st.error("‚ùå Kh√¥ng th·ªÉ l·∫•y th√¥ng tin columns t·ª´ sheet BA_US_2025!")
                                else:
                                    st.error("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn sheet BA_US_2025!")
                            else:
                                st.warning("‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi Google Sheets tr∆∞·ªõc ƒë·ªÉ ki·ªÉm tra columns!")
                    else:
                        st.error("‚ùå Kh√¥ng th·ªÉ detect th√°ng/nƒÉm t·ª´ t√™n file. Vui l√≤ng ki·ªÉm tra format t√™n file!")
                        st.info("üìù Format ƒë√∫ng: US_Search_Catalog_Performance_Simple_Month_2025_07_31.csv")
                else:
                    st.error("‚ùå File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng .csv")
        with col2:
            st.info("""
            **üìã H∆∞·ªõng d·∫´n:**
            1. Ch·ªçn file .csv Brand Analytics
            2. H·ªá th·ªëng t·ª± ƒë·ªông detect th√°ng/quarter
            3. Th√™m c·ªôt Month & Quarter
            4. Append v√†o sheet BA_US_2025
            
            **üìù Format t√™n file:**
            ```
            US_Search_Catalog_Performance_
            Simple_Month_2025_07_31.csv
            ```
                    
            **üî¢ Quarter mapping:**
            - Q1: Th√°ng 1,2,3
            - Q2: Th√°ng 4,5,6  
            - Q3: Th√°ng 7,8,9
            - Q4: Th√°ng 10,11,12
            
            **‚ö†Ô∏è L∆∞u √Ω:**
            - D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c append v√†o cu·ªëi sheet
            - Th·ª© t·ª± c·ªôt s·∫Ω ƒë∆∞·ª£c maintain theo sheet g·ªëc
            - C·ªôt Month v√† Quarter s·∫Ω ƒë∆∞·ª£c th√™m v√†o cu·ªëi
            """)    
    # Footer
    st.markdown("---")
    st.markdown("""
    <div style="text-align: center; color: #7f8c8d; margin-top: 2rem;">
        üìä Data Update Manager | Powered by Streamlit & Google Sheets API
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()